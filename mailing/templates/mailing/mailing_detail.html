{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h2>–î–µ—Ç–∞–ª–∏ —Ä–∞—Å—Å—ã–ª–∫–∏ #{{object.pk}}</h2>

            {# –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞ #}
            {% if object.owner == user or user.is_staff %}
            <form method="post" action="{% url 'mailing:send_manual' object.pk %}">
                {% csrf_token %}
                <button type="submit" class="btn btn-success">
                    üìß –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–µ–π—á–∞—Å
                </button>
            </form>
            {% endif %}
        </div>

        <div class="card-body">
            {# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ #}
            {% if object.owner != user and not user.is_staff %}
                <div class="alert alert-danger">
                    <h5>–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω</h5>
                    <p>–í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Ä–∞—Å—Å—ã–ª–∫–∏.</p>
                    <a href="{% url 'mailing:mailing_list' %}" class="btn btn-secondary">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É</a>
                </div>

            {% else %}
                <div class="row">
                    <div class="col-md-6">
                        <h5>–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h5>
                        <p><strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong> {{object.message.subject}}</p>
                        <p><strong>–°—Ç–∞—Ç—É—Å:</strong> {{ object.get_status_display }}</p>
                        <p><strong>–ü–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å:</strong> {{ object.get_frequency_display }}</p>
                        <p><strong>–í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏:</strong> {{ object.send_time }}</p>

                        {# –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ #}
                        {% if user.is_staff %}
                        <div class="mt-3 p-3 bg-light rounded">
                            <h6>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞</h6>
                            <p><strong>–í–ª–∞–¥–µ–ª–µ—Ü:</strong>
                                {% if object.owner %}
                                    {{ object.owner.username }} ({{ object.owner.email }})
                                {% else %}
                                    <span class="text-muted">–ù–µ —É–∫–∞–∑–∞–Ω</span>
                                {% endif %}
                            </p>
                            <p><strong>–ê–∫—Ç–∏–≤–Ω–∞:</strong>
                                {% if object.is_active %}
                                    <span class="badge bg-success">–î–∞</span>
                                {% else %}
                                    <span class="badge bg-danger">–ù–µ—Ç</span>
                                {% endif %}
                            </p>
                        </div>
                        {% endif %}
                    </div>

                    <div class="col-md-6">
                        <h5>–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ</h5>
                        <p><strong>–¢–µ–º–∞:</strong> {{object.subject}}</p>
                        <p><strong>–°–æ–æ–±—â–µ–Ω–∏–µ:</strong></p>
                        <div class="border p-2">
                            {{ object.message.body }}
                        </div>
                    </div>
                </div>

                <div class="mt-4">
                    <h5>–ü–æ–ª—É—á–∞—Ç–µ–ª–∏</h5>
                    {% if object.clients.all %}
                        <ul class="list-group">
                            {% for client in object.clients.all %}
                                <li class="list-group-item">{{ client.email }} - {{ client.full_name }}</li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p>–ü–æ–ª—É—á–∞—Ç–µ–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω—ã</p>
                    {% endif %}
                </div>

                <div class="mt-4">
                    <h5>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h5>
                    <p><strong>–°–æ–∑–¥–∞–Ω–∞:</strong> {{ object.created_at }}</p>
                    {% if object.updated_at %}
                        <p><strong>–û–±–Ω–æ–≤–ª–µ–Ω–∞:</strong> {{object.updated_at }}</p>
                    {% endif %}
                    {% if object.last_sent %}
                        <p><strong>–ü–æ—Å–ª–µ–¥–Ω—è—è –æ—Ç–ø—Ä–∞–≤–∫–∞:</strong> {{object.last_sent }}</p>
                    {% endif %}
                </div>

                <div class="mt-4">
                    <h5>–ò—Å—Ç–æ—Ä–∏—è –ø–æ–ø—ã—Ç–æ–∫</h5>
                    {% if object.attempts.all %}
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</th>
                                        <th>–°—Ç–∞—Ç—É—Å</th>
                                        <th>–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for attempt in object.attempts.all %}
                                        <tr>
                                            <td>{{ attempt.attempt_time }}</td>
                                            <td>
                                                <span class="badge {% if attempt.status == 'success' %}bg-success{% else %}bg-danger{% endif %}">
                                                    {{ attempt.get_status_display }}
                                                </span>
                                            </td>
                                            <td>{{ attempt.server_response|truncatechars:100 }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p>–ü–æ–ø—ã—Ç–æ–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ –µ—â–µ –Ω–µ –±—ã–ª–æ</p>
                    {% endif %}
                </div>
            {% endif %}
        </div>

        {# –§—É—Ç–µ—Ä —Å –∫–Ω–æ–ø–∫–∞–º–∏ –¥–µ–π—Å—Ç–≤–∏–π #}
        <div class="card-footer">
            <a href="{% url 'mailing:mailing_list' %}" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>

            {% if object.owner == user and not user.is_staff %}
                {# –í–ª–∞–¥–µ–ª–µ—Ü –º–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ —É–¥–∞–ª—è—Ç—å #}
                <a href="{% url 'mailing:mailing_update' object.pk %}" class="btn btn-primary">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
                <a href="{% url 'mailing:mailing_delete' object.pk %}" class="btn btn-danger">–£–¥–∞–ª–∏—Ç—å</a>

            {% elif user.is_staff %}
                {# –ú–µ–Ω–µ–¥–∂–µ—Ä –º–æ–∂–µ—Ç —Ç–æ–ª—å–∫–æ —É–ø—Ä–∞–≤–ª—è—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é #}
                <form method="post" action="{% url 'mailing:mailing_toggle' object.pk %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn {% if object.is_active %}btn-warning{% else %}btn-success{% endif %}">
                        {% if object.is_active %}‚è∏Ô∏è –ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å{% else %}‚ñ∂Ô∏è –í–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å{% endif %}
                    </button>
                </form>
                <a href="{% url 'users:user_list' %}" class="btn btn-outline-primary">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</a>

            {% else %}
                {# –ß—É–∂–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏ - —Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä #}
                <span class="text-muted ms-2">–¢–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä</span>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}